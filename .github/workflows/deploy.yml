name: Build and Deploy

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  BUILD_DIR: 'dist'

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run unit tests
        run: bun run test

      - name: Install Playwright browsers
        run: bunx playwright install --with-deps chromium

      - name: Run E2E tests (real API – envia dados ao Supabase)
        run: bun run test:e2e:real
        env:
          CI: "true"
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Notify Discord - Tests Success
        if: success()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -sS -H "Content-Type: application/json" -d '{
              "embeds": [{
                "title": "Testes concluídos com sucesso",
                "description": "Todos os testes (unitários e E2E) passaram.",
                "color": 3066993,
                "fields": [
                  {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                  {"name": "Commit", "value": "${{ github.sha }}", "inline": true},
                  {"name": "Autor", "value": "${{ github.actor }}", "inline": true},
                  {"name": "Workflow", "value": "[Ver logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}
                ],
                "footer": {"text": "GitHub Actions - Testes"}
              }]
            }' "$DISCORD_WEBHOOK_URL"
          fi

      - name: Notify Discord - Tests Failure
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -sS -H "Content-Type: application/json" -d '{
              "embeds": [{
                "title": "Testes falharam",
                "description": "Um ou mais testes falharam. Verifique os logs do job de testes.",
                "color": 15158332,
                "fields": [
                  {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                  {"name": "Commit", "value": "${{ github.sha }}", "inline": true},
                  {"name": "Autor", "value": "${{ github.actor }}", "inline": true},
                  {"name": "Workflow", "value": "[Ver logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}
                ],
                "footer": {"text": "GitHub Actions - Testes"}
              }]
            }' "$DISCORD_WEBHOOK_URL"
          fi

  build:
    name: Build Application
    runs-on: ubuntu-latest
    outputs:
      artifact-name: ${{ steps.artifact.outputs.name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run linter
        run: bun run lint
        continue-on-error: true

      - name: Resolve base path
        run: |
          BASE_PATH="${{ secrets.DEPLOY_DIR }}"
          if [ -z "$BASE_PATH" ]; then
            BASE_PATH="/"
          fi
          if [ "${BASE_PATH:0:1}" != "/" ]; then
            BASE_PATH="/$BASE_PATH"
          fi
          if [ "$BASE_PATH" != "/" ] && [ "${BASE_PATH: -1}" != "/" ]; then
            BASE_PATH="$BASE_PATH/"
          fi
          echo "Resolved BASE_PATH: $BASE_PATH"
          echo "VITE_BASE_PATH=$BASE_PATH" >> $GITHUB_ENV

      - name: Validate Supabase env
        run: |
          if [ -z "${{ secrets.VITE_SUPABASE_URL }}" ] || [ -z "${{ secrets.VITE_SUPABASE_ANON_KEY }}" ]; then
            echo "Error: Missing Supabase secrets (VITE_SUPABASE_URL / VITE_SUPABASE_ANON_KEY)"
            exit 1
          fi

      - name: Create .env.production for build
        run: |
          echo "VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }}" > .env.production
          echo "VITE_SUPABASE_ANON_KEY=${{ secrets.VITE_SUPABASE_ANON_KEY }}" >> .env.production
          echo "VITE_BASE_PATH=$VITE_BASE_PATH" >> .env.production

      - name: Build application
        run: |
          echo "Building with BASE_PATH: $VITE_BASE_PATH"
          bun run build
        env:
          NODE_ENV: production
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_BASE_PATH: ${{ env.VITE_BASE_PATH }}

      - name: Verify build output
        run: |
          if [ ! -d "${{ env.BUILD_DIR }}" ]; then
            echo "Error: Build directory not found"
            exit 1
          fi
          echo "Build artifacts:"
          ls -lah ${{ env.BUILD_DIR }}

      - name: Archive static bundle
        id: artifact
        run: |
          ARTIFACT_NAME="dist-$(date +%s).tar.gz"
          tar -czf "$ARTIFACT_NAME" -C ${{ env.BUILD_DIR }} .
          echo "name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          echo "Artefato criado: $ARTIFACT_NAME"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-bundle
          path: ${{ steps.artifact.outputs.name }}
          retention-days: 1

  deploy:
    name: Deploy to Server
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: dist-bundle

      - name: Set environment variables
        run: |
          echo "SSH_PORT=${{ secrets.SSH_PORT || '22' }}" >> $GITHUB_ENV
          echo "DEPLOY_PATH=${{ secrets.DEPLOY_PATH }}" >> $GITHUB_ENV

      - name: Validate SSH credentials
        run: |
          if [ -z "${{ secrets.SSH_HOST }}" ] || [ -z "${{ secrets.SSH_USER }}" ] || [ -z "${{ secrets.SSH_PASSWORD }}" ]; then
            echo "Error: SSH_HOST, SSH_USER e SSH_PASSWORD devem estar configurados como secrets"
            exit 1
          fi
          if [ -z "${{ secrets.DEPLOY_PATH }}" ]; then
            echo "Error: DEPLOY_PATH deve estar configurado como secret"
            exit 1
          fi
          echo "Credenciais SSH validadas"

      - name: Deploy to server via SSH (mkdir)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            mkdir -p ${{ secrets.DEPLOY_PATH }}
            mkdir -p /tmp/deploy-landing
          script_stop: true

      - name: Copy archive to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          source: "dist-bundle/*.tar.gz"
          target: "/tmp/deploy-landing"
          rm: false

      - name: Extract and deploy on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            set -e
            DEPLOY_ROOT="${{ secrets.DEPLOY_PATH }}"
            echo "Limpando diretório de deploy..."
            rm -rf "$DEPLOY_ROOT"/* || true
            LATEST_FILE=$(ls -t /tmp/deploy-landing/*.tar.gz 2>/dev/null | head -1)
            if [ -z "$LATEST_FILE" ]; then
              echo "Error: Nenhum arquivo .tar.gz encontrado"
              exit 1
            fi
            echo "Extraindo: $LATEST_FILE"
            tar -xzf "$LATEST_FILE" -C "$DEPLOY_ROOT"
            rm -f /tmp/deploy-landing/*.tar.gz || true
            echo "Deploy concluído em $DEPLOY_ROOT"

  notify-deploy:
    name: Notify Deploy Status
    needs: [build, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Notify Discord - Deploy Success
        if: needs.deploy.result == 'success' && needs.build.result == 'success'
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$WEBHOOK_URL" ]; then
            payload=$(cat <<'EOF'
          {
            "content": null,
            "embeds": [{
              "title": "Deploy concluído com sucesso",
              "description": "A aplicação foi buildada e publicada no servidor.",
              "color": 3066993,
              "fields": [
                {"name": "Repositório", "value": "${{ github.repository }}", "inline": true},
                {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "Commit", "value": "${{ github.sha }}", "inline": false},
                {"name": "Autor", "value": "${{ github.actor }}", "inline": true},
                {"name": "Servidor", "value": "${{ secrets.SSH_HOST }}", "inline": true},
                {"name": "Caminho", "value": "${{ secrets.DEPLOY_PATH }}", "inline": true},
                {"name": "Status", "value": "✅ Testes | ✅ Build | ✅ Deploy", "inline": false}
              ],
              "footer": {"text": "GitHub Actions"}
            }]
          }
          EOF
            )
            curl -sS -X POST -H "Content-Type: application/json" -d "$payload" "$WEBHOOK_URL"
          fi

      - name: Notify Discord - Deploy Failure
        if: needs.deploy.result == 'failure' || needs.build.result == 'failure'
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$WEBHOOK_URL" ]; then
            if [ "${{ needs.build.result }}" == "failure" ]; then
              FAILED_JOB="Build"
            else
              FAILED_JOB="Deploy"
            fi
            payload=$(cat <<EOF
          {
            "content": null,
            "embeds": [{
              "title": "Deploy falhou",
              "description": "O job $FAILED_JOB falhou. Verifique os logs do GitHub Actions.",
              "color": 15158332,
              "fields": [
                {"name": "Repositório", "value": "${{ github.repository }}", "inline": true},
                {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "Commit", "value": "${{ github.sha }}", "inline": false},
                {"name": "Job com falha", "value": "$FAILED_JOB", "inline": true},
                {"name": "Workflow", "value": "[Ver logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}
              ],
              "footer": {"text": "GitHub Actions"}
            }]
          }
          EOF
            )
            curl -sS -X POST -H "Content-Type: application/json" -d "$payload" "$WEBHOOK_URL"
          fi
